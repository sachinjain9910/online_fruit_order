stages:
  - install
  - test
  - lint
  - build
  - scan
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  SERVICES: "cart-service product-service user-service order-service notification-service"

# -------- Install Dependencies --------
install:
  stage: install
  image: node:18-alpine
  script:
    - for SVC in $SERVICES; do
        echo "Installing for $SVC" &&
        cd $SVC && npm ci && cd ..;
      done
  artifacts:
    paths:
      - **/node_modules/
    expire_in: 1h

# -------- Run Tests --------
test:
  stage: test
  image: node:18-alpine
  needs: ["install"]
  script:
    - npm install -g jest-junit
    - for SVC in $SERVICES; do
        echo "Testing $SVC" &&
        cd $SVC &&
        npm test -- --ci --reporters=default --reporters=jest-junit --coverage &&
        cd ..;
      done
  artifacts:
    when: always
    reports:
      junit: "**/junit.xml"
    paths:
      - **/coverage/
      - **/junit.xml
    expire_in: 1 week

# -------- ESLint --------
lint:
  stage: lint
  image: node:18-alpine
  needs: ["test"]
  script:
    - for SVC in $SERVICES; do 
        cd $SVC && npm run lint || true && cd ..;
      done

# -------- Build Docker Images --------
build:
  stage: build
  image: docker:27-dind
  services:
    - docker:27-dind
  needs: ["test"]
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
  script:
    - for SVC in $SERVICES; do
        docker build -t $CI_REGISTRY_IMAGE/$SVC:$CI_COMMIT_SHORT_SHA $SVC &&
        docker push $CI_REGISTRY_IMAGE/$SVC:$CI_COMMIT_SHORT_SHA;
      done

# -------- Security Scan: Trivy --------
scan:
  stage: scan
  image:
    name: aquasec/trivy:latest
    entrypoint: [""]
  needs: ["build"]
  script:
    - for SVC in $SERVICES; do
        trivy image --exit-code 0 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE/$SVC:$CI_COMMIT_SHORT_SHA;
      done
  allow_failure: true
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json

# -------- Mock Deploy --------
deploy:
  stage: deploy
  needs: ["scan"]
  script:
    - echo "ðŸš€ Mock Deployment Started"
    - echo "Containers Pulled Successfully"
    - echo "Mock Deployment Complete"
  when: manual  # Optional: allow manual trigger
  only:
    - main

stages:
  - install
  - test
  - build
  - scan
  - deploy

default:
  image: node:18-alpine
  before_script:
    - apk add --no-cache git
    - echo "Service: $SERVICE_NAME"

# Detect services affected by the latest commit
variables:
  SERVICES: "cart-service product-service user-service order-service notification-service"

.install_template: &install
  stage: install
  script:
    - cd $SERVICE_NAME
    - npm ci
  artifacts:
    paths:
      - $SERVICE_NAME/node_modules/
    expire_in: 1h

.test_template: &test
  stage: test
  script:
    - cd $SERVICE_NAME
    - npm run test -- --ci --reporters=default --reporters=jest-junit --coverage
  artifacts:
    when: always
    reports:
      junit: $SERVICE_NAME/junit.xml
    paths:
      - $SERVICE_NAME/coverage/
      - $SERVICE_NAME/junit.xml
    expire_in: 1 week

.build_template: &build
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  script:
    - cd $SERVICE_NAME
    - docker build -t $CI_REGISTRY_IMAGE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA .
    - docker push $CI_REGISTRY_IMAGE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA

.scan_template: &scan
  stage: scan
  image: docker:27
  services:
    - docker:27-dind
  script:
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $CI_REGISTRY_IMAGE/$SERVICE_NAME:$CI_COMMIT_SHORT_SHA
  allow_failure: true
  artifacts:
    reports:
      container_scanning: gl-container-scanning-report.json

# Generate jobs dynamically per service (one job per stage per service)
.install_jobs:
  extends: .install_template
  parallel:
    matrix:
      - SERVICE_NAME: cart-service
      - SERVICE_NAME: product-service
      - SERVICE_NAME: user-service
      - SERVICE_NAME: order-service
      - SERVICE_NAME: notification-service

.test_jobs:
  extends: .test_template
  needs: [".install_jobs"]
  parallel:
    matrix:
      - SERVICE_NAME: cart-service
      - SERVICE_NAME: product-service
      - SERVICE_NAME: user-service
      - SERVICE_NAME: order-service
      - SERVICE_NAME: notification-service

.build_jobs:
  extends: .build_template
  needs: [".test_jobs"]
  parallel:
    matrix:
      - SERVICE_NAME: cart-service
      - SERVICE_NAME: product-service
      - SERVICE_NAME: user-service
      - SERVICE_NAME: order-service
      - SERVICE_NAME: notification-service

.scan_jobs:
  extends: .scan_template
  needs: [".build_jobs"]
  parallel:
    matrix:
      - SERVICE_NAME: cart-service
      - SERVICE_NAME: product-service
      - SERVICE_NAME: user-service
      - SERVICE_NAME: order-service
      - SERVICE_NAME: notification-service

deploy:
  stage: deploy
  script:
    - echo "Mock Deploy completed"
  when: manual
  needs: [".scan_jobs"]
